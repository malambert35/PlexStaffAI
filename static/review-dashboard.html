<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlexStaffAI - Review Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .htmx-swapping { animation: fadeIn 0.3s ease-out; }
        .review-card { transition: all 0.3s; }
        .review-card:hover { transform: translateY(-4px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        .lang-selector {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 8px; background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px); padding: 8px; border-radius: 12px;
            border: 1px solid rgba(75, 85, 99, 0.5); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .lang-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
            background: transparent; color: #9CA3AF; }
        .lang-btn:hover { background: rgba(75, 85, 99, 0.5); color: #E5E7EB; }
        .lang-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-color: rgba(102, 126, 234, 0.5); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
        .lang-btn .flag { font-size: 18px; margin-right: 6px; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased min-h-screen">

    <!-- Language Selector -->
    <div class="lang-selector">
        <button class="lang-btn active" data-lang="fr" onclick="setLanguage('fr')">
            <span class="flag">üá´üá∑</span> FR
        </button>
        <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">
            <span class="flag">üá¨üáß</span> EN
        </button>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Header -->
        <header class="mb-12">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                <div class="text-center lg:text-left">
                    <h1 class="text-5xl lg:text-6xl font-black bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 bg-clip-text text-transparent mb-4">
                        üßë‚Äç‚öñÔ∏è <span data-i18n="reviewTitle">Tableau de R√©vision</span>
                    </h1>
                    <p class="text-xl lg:text-2xl text-gray-400 font-light">
                        <span data-i18n="reviewSubtitle">Requ√™tes en attente de validation manuelle</span>
                    </p>
                </div>

                <!-- Back to Dashboard + Refresh -->
                <div class="flex items-center gap-4">
                    <a href="/" class="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 
                                       px-6 py-3 rounded-xl font-bold transition shadow-xl text-center">
                        <span data-i18n="backToDashboard">‚Üê Dashboard</span>
                    </a>
                    <button onclick="loadReviews()" 
                            hx-get="/staff/reviews" 
                            hx-target="#reviews-container" 
                            hx-swap="innerHTML"
                            class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 
                                   px-8 py-3 rounded-xl font-bold text-lg shadow-xl transform hover:scale-105 
                                   transition-all duration-300 flex items-center gap-2">
                        <span class="text-2xl">üîÑ</span>
                        <span data-i18n="refresh">Actualiser</span>
                    </button>
                </div>
            </div>

            <!-- Review Count Badge -->
            <div class="flex justify-center lg:justify-start mt-8">
                <div id="review-count-badge" class="inline-flex items-center gap-3 bg-gradient-to-r from-yellow-900 to-orange-900 
                                                     px-8 py-4 rounded-2xl border-2 border-yellow-700 text-2xl font-black shadow-2xl">
                    <span class="text-3xl">üßë‚Äç‚öñÔ∏è</span>
                    <span id="review-count-text" data-i18n="reviewsWaiting">R√©visions en Attente <span id="review-count">0</span></span>
                </div>
            </div>
        </header>

        <!-- Reviews Container -->
        <div id="reviews-container" class="space-y-6">
            <!-- Loading state -->
            <div class="text-center py-16">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <div class="text-xl font-bold text-gray-400" data-i18n="loadingReviews">Chargement des r√©visions...</div>
            </div>
        </div>

    </div>

    <!-- Load translations -->
    <script src="/static/translations.js"></script>

    <script>
        let reviewCount = 0;

        // Update badge with count
        function updateBadge() {
            const countElement = document.getElementById('review-count');
            const badge = document.getElementById('review-count-badge');

            countElement.textContent = reviewCount;

            if (reviewCount === 0) {
                badge.classList.add('opacity-60');
            } else {
                badge.classList.remove('opacity-60');
            }
        }

        // Load reviews from API
        async function loadReviews() {
            try {
                const response = await fetch('/staff/reviews');
                const data = await response.json();
                const reviews = data.reviews || [];

                reviewCount = reviews.length;
                updateBadge();

                const container = document.getElementById('reviews-container');

                if (reviews.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16 bg-gray-800/30 rounded-2xl border-4 border-dashed border-gray-700">
                            <div class="text-6xl mb-4">‚úÖ</div>
                            <div class="text-3xl font-black mb-2 text-emerald-400">Aucune r√©vision en attente</div>
                            <div class="text-xl text-gray-400 mb-8">Toutes les demandes ont √©t√© trait√©es !</div>
                            <button onclick="loadReviews()" class="bg-emerald-600 hover:bg-emerald-700 px-8 py-3 rounded-xl font-bold transition">
                                üîÑ Actualiser
                            </button>
                        </div>
                    `;
                    return;
                }

                // Build review cards
                container.innerHTML = reviews.map(review => {
                    // Extraction robuste des donn√©es
                    const title = review.title || review.request_data?.title || `Request #${review.request_id}`;
                    const username = review.username || review.request_data?.requested_by || 'Unknown';
                    const mediaType = review.media_type || review.request_data?.media_type || 'unknown';
                    const year = review.request_data?.year || '';
                    const rating = review.request_data?.rating || 0;
                    const popularity = review.request_data?.popularity || 0;
                    const genres = review.request_data?.genres || [];
                    const episodeCount = review.request_data?.episode_count || 0;
                    const seasonCount = review.request_data?.season_count || 0;

                    const mediaIcon = mediaType === 'tv' ? 'üì∫' : 'üé¨';
                    const genresStr = genres.slice(0, 3).join(', ') || 'N/A';
                    const confidencePct = Math.round((review.ai_confidence || 0) * 100);

                    return `
                        <div class="review-card bg-gradient-to-br from-gray-800 to-gray-900 p-8 rounded-3xl border-2 border-yellow-700 hover:shadow-2xl transition-all hover:scale-[1.02]">
                            <!-- Header -->
                            <div class="flex justify-between items-start mb-6">
                                <div class="flex items-center gap-4">
                                    <div class="text-5xl">${mediaIcon}</div>
                                    <div>
                                        <div class="font-black text-2xl lg:text-3xl text-white mb-1">${title}</div>
                                        <div class="flex items-center gap-3 text-sm text-gray-400">
                                            <span class="bg-gray-900/50 px-3 py-1 rounded-full font-semibold uppercase">
                                                ${mediaType === 'tv' ? 'TV Series' : 'Movie'}
                                            </span>
                                            ${year ? `<span class="text-yellow-400">${year}</span>` : ''}
                                            <span class="text-yellow-400 font-bold">#${review.request_id}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Metadata -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">üë§</span>
                                    <span class="font-semibold">${username}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">‚≠ê</span>
                                    <span class="font-semibold">${rating}/10</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">üî•</span>
                                    <span class="font-semibold">${popularity.toFixed(1)}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">üé≠</span>
                                    <span class="font-semibold">${genresStr}</span>
                                </div>
                                ${mediaType === 'tv' ? `
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">üì∫</span>
                                    <span class="font-semibold">${seasonCount} saisons</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">üìº</span>
                                    <span class="font-semibold">${episodeCount} √©pisodes</span>
                                </div>
                                ` : ''}
                            </div>

                            <!-- AI Decision -->
                            <div class="bg-yellow-900/30 border-2 border-yellow-700 p-6 rounded-2xl mb-6">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-2xl">ü§ñ</span>
                                    <span class="text-yellow-400 font-bold text-xl uppercase tracking-wide">NEEDS_REVIEW</span>
                                    <span class="bg-yellow-900 px-3 py-1 rounded-full text-sm font-black border border-yellow-700">
                                        ${confidencePct}%
                                    </span>
                                </div>
                                <div class="text-sm text-yellow-200 leading-relaxed">
                                    <strong>Raison IA :</strong><br>
                                    <span>${review.ai_reason || 'No reason provided'}</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-4 pt-4 border-t border-yellow-900">
                                <button onclick="approveReview(${review.id}, '${title.replace(/'/g, "\\'")}', '${username}', '${mediaType}')"
                                        class="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 
                                               px-8 py-4 rounded-2xl font-bold text-lg shadow-2xl transform hover:scale-105 
                                               transition-all duration-300 text-white border-2 border-emerald-500">
                                    ‚úÖ <span data-i18n="approve">Approuver</span>
                                </button>
                                <button onclick="rejectReview(${review.id}, '${title.replace(/'/g, "\\'")}', '${username}', '${mediaType}')"
                                        class="flex-1 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 
                                               px-8 py-4 rounded-2xl font-bold text-lg shadow-2xl transform hover:scale-105 
                                               transition-all duration-300 text-white border-2 border-red-500">
                                    ‚ùå <span data-i18n="reject">Rejeter</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviews-container').innerHTML = `
                    <div class="text-center py-16 bg-red-900/30 rounded-3xl border-4 border-red-700 shadow-2xl">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <div class="text-3xl font-bold mb-2 text-red-300">Erreur de chargement</div>
                        <div class="text-xl text-red-400 mb-8">${error.message}</div>
                        <button onclick="loadReviews()" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-xl font-bold text-lg transition shadow-xl">
                            üîÑ R√©essayer
                        </button>
                    </div>
                `;
            }
        }

        // Approve review
        async function approveReview(reviewId, title, username, mediaType) {
            if (!confirm(`‚úÖ Approuver "${title}" ?`)) return;

            try {
                const response = await fetch(`/staff/review/${reviewId}/approve`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(`‚úÖ "${title}" approuv√© par ${username}`, 'success');
                    loadReviews();
                } else {
                    showNotification(`‚ùå Erreur: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
            }
        }

        // Reject review
        async function rejectReview(reviewId, title, username, mediaType) {
            if (!confirm(`‚ùå Rejeter "${title}" ?`)) return;

            try {
                const response = await fetch(`/staff/review/${reviewId}/reject`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(`‚ùå "${title}" rejet√©`, 'error');
                    loadReviews();
                } else {
                    showNotification(`‚ùå Erreur: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
            }
        }

        // Notification toast
        function showNotification(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-24 right-8 p-6 rounded-2xl shadow-2xl z-50 transform translate-x-full transition-all duration-300 ${
                type === 'success' ? 'bg-emerald-900/95 border-emerald-700 text-emerald-200' : 
                type === 'error' ? 'bg-red-900/95 border-red-700 text-red-200' : 
                'bg-blue-900/95 border-blue-700 text-blue-200'
            } border-2 max-w-md`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                    <div>${message}</div>
                </div>
            `;

            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);

            // Animate out
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadReviews();

            // Auto-refresh every 30s
            setInterval(loadReviews, 30000);
        });

        // HTMX fallback
        document.body.addEventListener('htmx:afterSwap', (evt) => {
            if (evt.detail.target.id === 'reviews-container') {
                loadReviews();
            }
        });
    </script>
</body>
</html>
